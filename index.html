<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Jadwal Imsakiyah Ramadan</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Lexend', 'sans-serif'] },
                    colors: {
                        emerald: { 50: '#ecfdf5', 100: '#d1fae5', 500: '#10b981', 600: '#059669', 700: '#047857', 900: '#064e3b' }
                    },
                    animation: { 'marquee': 'marquee 15s linear infinite' },
                    keyframes: { marquee: { '0%': { transform: 'translateX(0)' }, '100%': { transform: 'translateX(-50%)' } } }
                }
            }
        }
    </script>
    <style>
        * { font-family: 'Lexend', sans-serif !important; }
        #timer { font-size: 3.5rem !important; line-height: 1 !important; font-variant-numeric: tabular-nums; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .dark .glass-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(255, 255, 255, 0.05); }
        .row-today { background-color: #f0fdf4 !important; border-left: 4px solid #10b981; }
        .dark .row-today { background-color: rgba(16, 185, 129, 0.15) !important; }
        .sticky-th { position: sticky; top: 0; z-index: 10; background-color: #ffffff; }
        .dark .sticky-th { background-color: #1e293b; }
        .marquee-container { overflow: hidden; white-space: nowrap; display: flex; }
        .marquee-content { display: flex; flex-shrink: 0; min-width: 100%; align-items: center; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen pb-20 transition-colors duration-300">

    <div class="bg-emerald-900 text-emerald-50 py-2 marquee-container border-b border-emerald-700">
        <div class="marquee-content animate-marquee" id="marquee-1"></div>
        <div class="marquee-content animate-marquee" id="marquee-2"></div>
    </div>

    <header class="bg-gradient-to-br from-emerald-600 to-emerald-900 pt-12 pb-24 px-6 rounded-b-[3rem] shadow-2xl">
        <div class="max-w-4xl mx-auto text-center">
            <span id="year-badge" class="inline-block px-8 py-3 rounded-full bg-white/20 text-white text-sm font-bold tracking-widest mb-4 uppercase">MEMUAT TAHUN...</span>
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-8">Jadwal Imsakiyah Kemenag RI</h1>

            <div class="flex items-center gap-2 max-w-lg mx-auto relative">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Cari Kota/Kabupaten..." 
                        class="w-full pl-12 pr-4 py-4 rounded-2xl bg-white shadow-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-slate-800">
                    <div id="results" class="absolute left-0 right-0 z-[100] mt-2 bg-white dark:bg-slate-800 rounded-2xl max-h-72 overflow-y-auto hidden shadow-2xl border border-slate-100 dark:border-slate-700 text-left"></div>
                </div>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-4 bg-white/10 hover:bg-white/20 text-white rounded-2xl border border-white/20 backdrop-blur-sm transition-all">
                    <i data-lucide="sun-moon" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto -mt-12 px-4 relative z-10">
        <div id="empty-state" class="glass-card rounded-3xl p-12 text-center shadow-xl">
            <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="map-pin" class="w-10 h-10 text-emerald-500"></i>
            </div>
            <h2 class="text-xl font-semibold mb-2">Pilih Lokasi Terlebih Dahulu</h2>
            <p id="empty-state-text" class="text-slate-500 dark:text-slate-400">Silakan cari kota Anda untuk melihat jadwal.</p>
        </div>

        <div id="main-ui" class="hidden space-y-6">
            <div class="glass-card rounded-3xl p-6 md:p-8 shadow-xl">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                    <div>
                        <div class="flex items-center gap-2 text-emerald-600 dark:text-emerald-400 font-bold mb-2">
                            <i data-lucide="map-pin" class="w-4 h-4"></i>
                            <span id="city-name-display" class="tracking-widest uppercase text-sm">-</span>
                        </div>
                        <h2 id="current-date-display" class="text-2xl font-bold mb-1">...</h2>
                        <p id="hijri-display" class="text-slate-500 dark:text-slate-400 font-medium">Memuat info...</p>
                    </div>
                    <div class="bg-emerald-50 dark:bg-slate-900/80 border border-emerald-100 dark:border-slate-700 rounded-3xl p-6 text-center">
                        <span id="label-status" class="text-xs font-bold tracking-widest text-emerald-600 dark:text-emerald-400 uppercase">Menghitung</span>
                        <div id="timer" class="font-bold my-2 text-slate-800 dark:text-white">00:00:00</div>
                        <div id="clock" class="text-lg font-medium text-slate-400 italic">--:--:--</div>
                    </div>
                </div>
                <div id="grid-times" class="grid grid-cols-3 md:grid-cols-6 gap-3 mt-10"></div>
            </div>

            <div class="glass-card rounded-3xl shadow-xl overflow-hidden">
                <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-700 bg-white/50 dark:bg-slate-800/50">
                    <h3 id="table-title" class="font-bold text-slate-700 dark:text-slate-200">Daftar Jadwal Ramadan</h3>
                </div>
                <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="sticky-th text-[12px] text-slate-400 uppercase tracking-wider">
                                <th class="px-6 py-4 text-center">Ramadan</th>
                                <th class="px-4 py-4 text-emerald-600 dark:text-emerald-400 font-bold">Imsak</th>
                                <th class="px-4 py-4">Subuh</th>
                                <th class="px-4 py-4">Zuhur</th>
                                <th class="px-4 py-4">Asar</th>
                                <th class="px-4 py-4 text-emerald-600 dark:text-emerald-400 font-bold">Maghrib</th>
                                <th class="px-4 py-4">Isya</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-slate-100 dark:divide-slate-800 text-base"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        let kotaList = [];
        let jadwalRamadan = [];
        let selectedCityName = "";
        let currentOffset = 7; 
        
        const CONFIG = {
            hijriYear: "1447 H",
            startDate: "2026-02-19" 
        };

        // Fungsi bantuan untuk merapikan nama kota (KOTA JAKARTA -> DKI JAKARTA)
        function formatNamaKota(nama) {
            let n = nama.toUpperCase();
            if (n.includes("KOTA JAKARTA")) {
                return n.replace("KOTA JAKARTA", "DKI JAKARTA");
            }
            return n;
        }

        function setupUI() {
            const yearMasehi = new Date(CONFIG.startDate).getFullYear();
            document.getElementById('year-badge').innerText = `RAMADAN ${CONFIG.hijriYear} / ${yearMasehi} M`;
            document.getElementById('table-title').innerText = `Daftar Jadwal Ramadan ${CONFIG.hijriYear}`;
            document.getElementById('empty-state-text').innerText = `Silakan cari kota Anda untuk melihat jadwal Ramadan ${CONFIG.hijriYear}.`;

            const marqueeHTML = `
                <span class="mx-2 text-sm italic">âœ¨ Marhaban Ya Ramadan</span>
                <span class="mx-2 text-sm opacity-50">|</span>
                <span class="mx-2 text-sm italic">ðŸ•Œ Selamat Menunaikan Ibadah Puasa</span>
            `.repeat(5); 
            document.getElementById('marquee-1').innerHTML = marqueeHTML;
            document.getElementById('marquee-2').innerHTML = marqueeHTML;
        }

        async function init() {
            setupUI();
            lucide.createIcons();
            document.getElementById('current-date-display').innerText = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric'});
            
            try {
                const res = await fetch('https://api.myquran.com/v2/sholat/kota/semua');
                const json = await res.json();
                kotaList = json.data;
            } catch (e) { console.error("Gagal ambil daftar kota"); }
            
            setInterval(updateClock, 1000);
        }

        const input = document.getElementById('search-input');
        const results = document.getElementById('results');

        input.addEventListener('input', (e) => {
            let val = e.target.value.toLowerCase();
            if(val.length < 2) { results.classList.add('hidden'); return; }
            const match = kotaList.filter(k => k.lokasi.toLowerCase().includes(val)).slice(0, 8);
            if(match.length > 0) {
                results.innerHTML = match.map(k => {
                    const namaTampil = formatNamaKota(k.lokasi);
                    return `
                    <div onclick="getRamadanJadwal('${k.id}', '${namaTampil}')" class="px-5 py-4 hover:bg-emerald-50 dark:hover:bg-slate-700/50 cursor-pointer flex items-center gap-3 border-b border-slate-50 dark:border-slate-700 last:border-0">
                        <i data-lucide="map-pin" class="w-4 h-4 text-emerald-500"></i>
                        <span class="font-medium">${namaTampil}</span>
                    </div>
                `}).join('');
                lucide.createIcons();
                results.classList.remove('hidden');
            } else { results.classList.add('hidden'); }
        });

        async function getRamadanJadwal(id, nama) {
            input.value = '';
            results.classList.add('hidden');
            selectedCityName = nama;
            document.getElementById('city-name-display').innerText = nama;
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');

            const n = nama.toUpperCase();
            // Logika Zona Waktu
            if (n.match(/BALI|DENPASAR|MAKASSAR|MANADO|SAMARINDA|KUPANG|MATARAM|GORONTALO|BALIKPAPAN/)) {
                currentOffset = 8; 
            } else if (n.match(/PAPUA|MALUKU|AMBON|JAYAPURA|SORONG|TERNATE/)) {
                currentOffset = 9; 
            } else {
                currentOffset = 7; 
            }

            const startDate = new Date(CONFIG.startDate);
            const year = startDate.getFullYear();
            const month = startDate.getMonth() + 1;
            
            const nextDate = new Date(year, month, 1);
            const nextYear = nextDate.getFullYear();
            const nextMonth = nextDate.getMonth() + 1;

            try {
                const [resCurrent, resNext] = await Promise.all([
                    fetch(`https://api.myquran.com/v2/sholat/jadwal/${id}/${year}/${month.toString().padStart(2,'0')}`),
                    fetch(`https://api.myquran.com/v2/sholat/jadwal/${id}/${nextYear}/${nextMonth.toString().padStart(2,'0')}`)
                ]);
                
                const jsonCurrent = await resCurrent.json();
                const jsonNext = await resNext.json();

                if(jsonCurrent.status && jsonNext.status) {
                    const combined = [...jsonCurrent.data.jadwal, ...jsonNext.data.jadwal];
                    const startIndex = combined.findIndex(d => d.date === CONFIG.startDate);
                    if (startIndex !== -1) {
                        jadwalRamadan = combined.slice(startIndex, startIndex + 30);
                        render(jadwalRamadan);
                    } else {
                        alert("Tanggal mulai Ramadan tidak ditemukan di data API.");
                    }
                }
            } catch (e) { alert("Gagal memuat jadwal."); }
        }

        function render(list) {
            const table = document.getElementById('table-body');
            const grid = document.getElementById('grid-times');
            table.innerHTML = '';
            
            const nowUTC = new Date().getTime() + (new Date().getTimezoneOffset() * 60000);
            const cityNow = new Date(nowUTC + (3600000 * currentOffset));
            const todayStr = cityNow.toLocaleDateString('en-CA'); 
            
            const currentJadwalToday = list.find(d => d.date === todayStr) || list[0];

            const times = [
                {label: 'Imsak', time: currentJadwalToday.imsak, highlight: true},
                {label: 'Subuh', time: currentJadwalToday.subuh},
                {label: 'Zuhur', time: currentJadwalToday.dzuhur},
                {label: 'Asar', time: currentJadwalToday.ashar},
                {label: 'Maghrib', time: currentJadwalToday.maghrib, highlight: true},
                {label: 'Isya', time: currentJadwalToday.isya}
            ];

            grid.innerHTML = times.map(t => `
                <div class="p-3 rounded-2xl border transition-all ${t.highlight ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-200' : 'bg-slate-50 dark:bg-slate-800/50 text-slate-400'} border-transparent">
                    <p class="text-[10px] font-bold uppercase mb-1 opacity-70 text-center">${t.label}</p>
                    <p class="font-bold text-base text-center">${t.time}</p>
                </div>
            `).join('');

            list.forEach((d, index) => {
                const isToday = d.date === todayStr;
                const tr = document.createElement('tr');
                if(isToday) { tr.className = 'row-today'; tr.id = 'today-row'; }
                tr.innerHTML = `
                    <td class="px-6 py-4 text-center font-bold text-slate-600 dark:text-slate-300">Ke-${index + 1}</td>
                    <td class="px-4 py-4 font-bold text-emerald-600 dark:text-emerald-400">${d.imsak}</td>
                    <td class="px-4 py-4 font-medium text-slate-500">${d.subuh}</td>
                    <td class="px-4 py-4 font-medium text-slate-500">${d.dzuhur}</td>
                    <td class="px-4 py-4 font-medium text-slate-500">${d.ashar}</td>
                    <td class="px-4 py-4 font-bold text-emerald-600 dark:text-emerald-400">${d.maghrib}</td>
                    <td class="px-4 py-4 font-medium text-slate-500">${d.isya}</td>
                `;
                table.appendChild(tr);
            });

            document.getElementById('hijri-display').innerText = currentJadwalToday.tanggal;
            setTimeout(() => { document.getElementById('today-row')?.scrollIntoView({behavior: 'smooth', block: 'center'}); }, 500);
        }

        function updateClock() {
            const nowUTC = new Date().getTime() + (new Date().getTimezoneOffset() * 60000);
            const cityTime = new Date(nowUTC + (3600000 * currentOffset));
            const tzName = currentOffset === 7 ? "WIB" : currentOffset === 8 ? "WITA" : "WIT";
            const timeStr = cityTime.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: false}).replace(/\./g, ':');
            document.getElementById('clock').innerText = `${timeStr} ${tzName}`;

            if (!jadwalRamadan || jadwalRamadan.length === 0) return;
            const todayStr = cityTime.toLocaleDateString('en-CA');
            const tomorrowTime = new Date(cityTime.getTime() + 86400000);
            const tomorrowStr = tomorrowTime.toLocaleDateString('en-CA');
            const todayJadwal = jadwalRamadan.find(d => d.date === todayStr);
            const tomorrowJadwal = jadwalRamadan.find(d => d.date === tomorrowStr);

            const parseToDate = (dateStr, timeStr) => {
                const [h, m] = timeStr.split(':');
                const d = new Date(dateStr);
                d.setHours(parseInt(h), parseInt(m), 0, 0);
                return d;
            };

            let target = null;
            let status = "";

            if (todayJadwal) {
                const imsakToday = parseToDate(todayJadwal.date, todayJadwal.imsak);
                const maghribToday = parseToDate(todayJadwal.date, todayJadwal.maghrib);
                if (cityTime < imsakToday) {
                    target = imsakToday;
                    status = "Menuju Imsak";
                } else if (cityTime < maghribToday) {
                    target = maghribToday;
                    status = "Menuju Buka Puasa";
                } else if (tomorrowJadwal) {
                    target = parseToDate(tomorrowJadwal.date, tomorrowJadwal.imsak);
                    status = "Menuju Imsak Besok";
                }
            }

            if (target) {
                const diff = target - cityTime;
                const h = Math.floor(diff / 3600000).toString().padStart(2, '0');
                const m = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
                document.getElementById('label-status').innerText = status;
                document.getElementById('timer').innerText = `${h}:${m}:${s}`;
            }
        }
        window.addEventListener('load', init);
    </script>
</body>
</html>
